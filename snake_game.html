<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è´ªåƒè›‡æ¸¸æˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        /* ä½¿ç”¨ Tailwind CSSï¼Œä½†ä¸ºæ¸¸æˆæ·»åŠ ä¸€äº›è‡ªå®šä¹‰æ ·å¼ */
        :root {
            --game-bg: #1f2937; /* ç°è‰² 800 */
            --snake-color: #10b981; /* ç¿ ç»¿ 500 */
            --food-color: #ef4444; /* çº¢è‰² 500 */
            --text-color: #f3f4f6; /* ç°è‰² 100 */
            --game-width: 400px;
        }

        body {
            font-family: 'Press Start 2P', cursive;
            background-color: #0d1117; /* æ·±å¤œé»‘èƒŒæ™¯ */
        }

        .game-container {
            width: var(--game-width);
            max-width: 95vw;
            background: var(--game-bg);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5), 0 0 0 10px #374151; /* å¤–æ¡†é˜´å½± */
            border-radius: 12px;
            overflow: hidden;
        }

        #gameCanvas {
            display: block;
            background-color: #111827; /* ç”»å¸ƒæ›´æ·±è‰² */
            border-radius: 6px;
        }

        .score-board {
            padding: 1rem 1.5rem;
            color: var(--text-color);
            border-top: 2px solid #374151;
            font-size: 0.8rem;
        }
        
        .game-message {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.75);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            border-radius: 6px;
            z-index: 10;
        }

        .message-title {
            font-size: 1.5rem;
            margin-bottom: 1rem;
            color: #fcd34d; /* ç¥ç€è‰² */
        }

        .message-button {
            background-color: var(--snake-color);
            color: #1f2937;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 4px #047857;
            font-size: 0.7rem;
            margin-top: 1.5rem;
        }

        .message-button:hover {
            background-color: #059669;
            box-shadow: 0 2px #047857;
            transform: translateY(2px);
        }

        /* ç§»åŠ¨ç«¯æ§åˆ¶æŒ‰é’® */
        .controls {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 1rem;
        }
        .control-row {
            display: flex;
            gap: 1rem;
        }
        .control-btn {
            background-color: #374151;
            color: var(--text-color);
            width: 60px;
            height: 60px;
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 50%;
            font-size: 1.25rem;
            cursor: pointer;
            user-select: none;
            box-shadow: 0 3px #1f2937;
            transition: background-color 0.1s;
        }
        .control-btn:active {
            box-shadow: none;
            transform: translateY(3px);
            background-color: #4b5563;
        }

        @media (min-width: 768px) {
            .controls {
                display: none; /* æ¡Œé¢ç«¯éšè—è§¦æ§æŒ‰é’® */
            }
        }
    </style>
</head>
<body class="flex flex-col items-center justify-center min-h-screen p-4">

    <!-- æ¸¸æˆå®¹å™¨ -->
    <div class="game-container relative">
        <h1 class="text-xl text-center p-4 text-white" style="font-family: 'Press Start 2P', cursive;">è´ªåƒè›‡</h1>

        <!-- ç”»å¸ƒå°†åœ¨æ­¤å¤„æ¸²æŸ“æ¸¸æˆ -->
        <canvas id="gameCanvas" width="400" height="400"></canvas>
        
        <!-- æ¸¸æˆæ¶ˆæ¯/å¼€å§‹ç•Œé¢ -->
        <div id="gameMessage" class="game-message">
            <div class="message-title">ğŸ è´ªåƒè›‡ ğŸ</div>
            <p>æŒ‰ç®­å¤´é”®æˆ– WASD ç§»åŠ¨</p>
            <div class="message-button" onclick="startGame()">å¼€å§‹æ¸¸æˆ</div>
        </div>

        <!-- è®°åˆ†æ¿ -->
        <div class="score-board flex justify-between items-center">
            <div id="scoreDisplay">åˆ†æ•°: 0</div>
            <div id="highScoreDisplay">æœ€é«˜åˆ†: 0</div>
        </div>
    </div>

    <!-- ç§»åŠ¨ç«¯æ§åˆ¶æŒ‰é’® -->
    <div class="controls mt-6 md:mt-0">
        <div class="control-row">
            <div class="control-btn invisible"></div>
            <div class="control-btn" id="upBtn">â–²</div>
            <div class="control-btn invisible"></div>
        </div>
        <div class="control-row mt-4">
            <div class="control-btn" id="leftBtn">â—€</div>
            <div class="control-btn invisible"></div>
            <div class="control-btn" id="rightBtn">â–¶</div>
        </div>
        <div class="control-row mt-4">
            <div class="control-btn invisible"></div>
            <div class="control-btn" id="downBtn">â–¼</div>
            <div class="control-btn invisible"></div>
        </div>
    </div>


    <script>
        // æ¸¸æˆå¸¸é‡å’Œåˆå§‹åŒ–
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const scoreDisplay = document.getElementById('scoreDisplay');
        const highScoreDisplay = document.getElementById('highScoreDisplay');
        const gameMessage = document.getElementById('gameMessage');

        const GRID_SIZE = 20; // æ¸¸æˆç½‘æ ¼çš„å¤§å° (20x20)
        const TILE_SIZE = canvas.width / GRID_SIZE; // æ¯ä¸ªæ–¹å—çš„åƒç´ å¤§å° (400/20 = 20px)
        const GAME_SPEED = 150; // æ¸¸æˆæ›´æ–°é€Ÿåº¦ (æ¯«ç§’, è¶Šå¤§è¶Šæ…¢)

        let snake;
        let food;
        let dx, dy; // ç§»åŠ¨æ–¹å‘ (x, y)
        let score;
        let lastTime = 0;
        let accumulatedTime = 0;
        let isPaused = true; // æ¸¸æˆæš‚åœ/æœªå¼€å§‹çŠ¶æ€
        let directionBuffer = []; // ç”¨äºå­˜å‚¨è¿ç»­æ–¹å‘è¾“å…¥
        let isMoving = false; // è›‡æ˜¯å¦å·²ç»å¼€å§‹ç§»åŠ¨

        // åˆå§‹åŒ–æ¸¸æˆçŠ¶æ€
        function resetGame() {
            // è›‡çš„åˆå§‹ä½ç½® (é•¿åº¦ä¸º3ï¼Œä½äºä¸­å¤®é™„è¿‘)
            snake = [
                { x: 10, y: 10 },
                { x: 9, y: 10 },
                { x: 8, y: 10 },
            ];
            dx = 1; // é»˜è®¤å‘å³ç§»åŠ¨
            dy = 0;
            score = 0;
            isPaused = true;
            isMoving = false;
            directionBuffer = [];
            scoreDisplay.textContent = `åˆ†æ•°: 0`;
            updateHighScoreDisplay();
            placeFood();
            drawGame(); // ç»˜åˆ¶åˆå§‹çŠ¶æ€
        }

        // æ›´æ–°æœ€é«˜åˆ†æ˜¾ç¤º
        function updateHighScoreDisplay() {
            const highScore = localStorage.getItem('snakeHighScore') || 0;
            highScoreDisplay.textContent = `æœ€é«˜åˆ†: ${highScore}`;
        }

        // æ”¾ç½®é£Ÿç‰©
        function placeFood() {
            let newFood;
            do {
                // éšæœºç”Ÿæˆé£Ÿç‰©ä½ç½®
                newFood = {
                    x: Math.floor(Math.random() * GRID_SIZE),
                    y: Math.floor(Math.random() * GRID_SIZE)
                };
            } while (isFoodOnSnake(newFood)); // ç¡®ä¿é£Ÿç‰©ä¸ä¼šç”Ÿæˆåœ¨è›‡èº«ä¸Š
            food = newFood;
        }

        // æ£€æŸ¥é£Ÿç‰©æ˜¯å¦ä¸è›‡èº«é‡å 
        function isFoodOnSnake(pos) {
            return snake.some(segment => segment.x === pos.x && segment.y === pos.y);
        }

        // ç»˜åˆ¶å•ä¸ªæ–¹å—
        function drawTile(x, y, color) {
            ctx.fillStyle = color;
            ctx.fillRect(x * TILE_SIZE, y * TILE_SIZE, TILE_SIZE, TILE_SIZE);
            // æ·»åŠ å°åœ†è§’å’Œè¾¹æ¡†æ•ˆæœ
            ctx.strokeStyle = '#111827';
            ctx.lineWidth = 1;
            ctx.strokeRect(x * TILE_SIZE, y * TILE_SIZE, TILE_SIZE, TILE_SIZE);
        }

        // ç»˜åˆ¶æ¸¸æˆçŠ¶æ€
        function drawGame() {
            // æ¸…ç©ºç”»å¸ƒ
            ctx.fillStyle = '#111827';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // ç»˜åˆ¶é£Ÿç‰© (çº¢è‰²åœ†å½¢)
            ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--food-color');
            ctx.beginPath();
            ctx.arc(
                food.x * TILE_SIZE + TILE_SIZE / 2,
                food.y * TILE_SIZE + TILE_SIZE / 2,
                TILE_SIZE / 2 * 0.8, // ç¨å¾®å°ä¸€ç‚¹
                0,
                2 * Math.PI
            );
            ctx.fill();

            // ç»˜åˆ¶è›‡
            snake.forEach((segment, index) => {
                const color = getComputedStyle(document.documentElement).getPropertyValue('--snake-color');
                drawTile(segment.x, segment.y, color);

                // ç»˜åˆ¶è›‡å¤´ (æ·»åŠ ä¸€ä¸ªçœ¼ç›æ•ˆæœ)
                if (index === 0) {
                    ctx.fillStyle = '#f3f4f6'; // çœ¼ç›é¢œè‰²
                    const eyeSize = TILE_SIZE * 0.2;
                    let eyeX, eyeY;

                    // æ ¹æ®æ–¹å‘ç¡®å®šçœ¼ç›ä½ç½®
                    if (dx === 1) { // Right
                        eyeX = segment.x * TILE_SIZE + TILE_SIZE * 0.6;
                        eyeY = segment.y * TILE_SIZE + TILE_SIZE * 0.3;
                    } else if (dx === -1) { // Left
                        eyeX = segment.x * TILE_SIZE + TILE_SIZE * 0.2;
                        eyeY = segment.y * TILE_SIZE + TILE_SIZE * 0.3;
                    } else if (dy === 1) { // Down
                        eyeX = segment.x * TILE_SIZE + TILE_SIZE * 0.3;
                        eyeY = segment.y * TILE_SIZE + TILE_SIZE * 0.6;
                    } else if (dy === -1) { // Up
                        eyeX = segment.x * TILE_SIZE + TILE_SIZE * 0.3;
                        eyeY = segment.y * TILE_SIZE + TILE_SIZE * 0.2;
                    }

                    // ç»˜åˆ¶ä¸¤ä¸ªçœ¼ç›
                    ctx.beginPath();
                    ctx.arc(eyeX, eyeY, eyeSize, 0, 2 * Math.PI);
                    ctx.arc(eyeX + (dx !== 0 ? 0 : TILE_SIZE * 0.4), eyeY + (dy !== 0 ? 0 : TILE_SIZE * 0.4), eyeSize, 0, 2 * Math.PI);
                    ctx.fill();
                }
            });
        }

        // å¤„ç†æ¸¸æˆé€»è¾‘æ›´æ–°
        function updateGame() {
            if (isPaused) return;

            // 1. å¤„ç†æ–¹å‘ç¼“å†²
            if (directionBuffer.length > 0) {
                const nextDirection = directionBuffer.shift();
                dx = nextDirection.dx;
                dy = nextDirection.dy;
            }
            
            // 2. è®¡ç®—æ–°è›‡å¤´ä½ç½®
            const head = { x: snake[0].x + dx, y: snake[0].y + dy };

            // 3. ç¢°æ’æ£€æµ‹
            // å¢™å£ç¢°æ’
            if (head.x < 0 || head.x >= GRID_SIZE || head.y < 0 || head.y >= GRID_SIZE) {
                handleGameOver();
                return;
            }

            // è‡ªèº«ç¢°æ’ (æ£€æŸ¥æ–°å¤´éƒ¨æ˜¯å¦ä¸è›‡èº«é‡å )
            if (isFoodOnSnake(head)) {
                // å¦‚æœç¢°æ’ç‚¹ä¸æ˜¯å°¾å·´çš„æœ€åä¸€ä¸ªå•å…ƒï¼Œåˆ™æ¸¸æˆç»“æŸ (å› ä¸ºå°¾å·´ä¼šç§»é™¤)
                let collisionIndex = snake.findIndex(segment => segment.x === head.x && segment.y === head.y);
                if (collisionIndex !== -1 && collisionIndex < snake.length - 1) {
                    handleGameOver();
                    return;
                }
            }
            
            // 4. å°†æ–°å¤´éƒ¨æ·»åŠ åˆ°è›‡çš„å¼€å¤´
            snake.unshift(head);

            // 5. é£Ÿç‰©æ£€æµ‹
            if (head.x === food.x && head.y === food.y) {
                // åƒåˆ°é£Ÿç‰©ï¼Œåˆ†æ•°å¢åŠ ï¼Œä¸ç§»é™¤å°¾å·´ (è›‡å˜é•¿)
                score += 10;
                scoreDisplay.textContent = `åˆ†æ•°: ${score}`;
                placeFood();
            } else {
                // æ²¡æœ‰åƒåˆ°é£Ÿç‰©ï¼Œç§»é™¤å°¾å·´ (è›‡ç§»åŠ¨)
                snake.pop();
            }

            // 6. é‡æ–°ç»˜åˆ¶
            drawGame();
        }

        // æ¸¸æˆå¾ªç¯
        function gameLoop(timestamp) {
            if (!isPaused) {
                const deltaTime = timestamp - lastTime;
                lastTime = timestamp;
                accumulatedTime += deltaTime;

                // åªæœ‰å½“ç´¯ç§¯æ—¶é—´è¶…è¿‡ GAME_SPEED æ—¶æ‰æ›´æ–°æ¸¸æˆé€»è¾‘
                while (accumulatedTime >= GAME_SPEED) {
                    updateGame();
                    accumulatedTime -= GAME_SPEED;
                }
            }

            requestAnimationFrame(gameLoop);
        }

        // æ¸¸æˆç»“æŸå¤„ç†
        function handleGameOver() {
            isPaused = true;
            // æ›´æ–°æœ€é«˜åˆ†
            const currentHighScore = parseInt(localStorage.getItem('snakeHighScore') || 0);
            if (score > currentHighScore) {
                localStorage.setItem('snakeHighScore', score);
            }
            updateHighScoreDisplay();

            // æ˜¾ç¤ºæ¸¸æˆç»“æŸæ¶ˆæ¯
            gameMessage.innerHTML = `
                <div class="message-title text-red-500">æ¸¸æˆç»“æŸ!</div>
                <p>æœ€ç»ˆåˆ†æ•°: ${score}</p>
                <p>æœ€é«˜åˆ†: ${localStorage.getItem('snakeHighScore')}</p>
                <div class="message-button" onclick="startGame()">å†ç©ä¸€æ¬¡</div>
            `;
            gameMessage.classList.remove('hidden');
        }

        // å¯åŠ¨/é‡æ–°å¼€å§‹æ¸¸æˆ
        window.startGame = function() {
            resetGame();
            isPaused = false;
            gameMessage.classList.add('hidden');
        }

        // å¤„ç†æ–¹å‘è¾“å…¥
        function changeDirection(newDx, newDy) {
            // é¿å…ç«‹å³åå‘ç§»åŠ¨
            const currentDx = directionBuffer.length > 0 ? directionBuffer[directionBuffer.length - 1].dx : dx;
            const currentDy = directionBuffer.length > 0 ? directionBuffer[directionBuffer.length - 1].dy : dy;

            if (newDx === -currentDx && newDy === -currentDy) {
                return; // å¿½ç•¥åå‘è¾“å…¥
            }
            
            // æ¸¸æˆå¼€å§‹ç§»åŠ¨æ ‡è®°
            isMoving = true;

            // ç¼“å†²è¾“å…¥ï¼Œæœ€å¤šåªç¼“å†²ä¸€ä¸ªæ–¹å‘
            if (directionBuffer.length < 1) {
                directionBuffer.push({ dx: newDx, dy: newDy });
            }

            // å¦‚æœæ¸¸æˆæš‚åœï¼Œåˆ™ç›´æ¥å¼€å§‹æ¸¸æˆ
            if (isPaused) {
                startGame();
            }
        }

        // é”®ç›˜äº‹ä»¶ç›‘å¬
        document.addEventListener('keydown', (e) => {
            if (isPaused && e.key === ' ' || isPaused && e.key === 'Enter') {
                startGame();
                e.preventDefault();
                return;
            }

            switch (e.key) {
                case 'ArrowUp':
                case 'w':
                case 'W':
                    changeDirection(0, -1);
                    break;
                case 'ArrowDown':
                case 's':
                case 'S':
                    changeDirection(0, 1);
                    break;
                case 'ArrowLeft':
                case 'a':
                case 'A':
                    changeDirection(-1, 0);
                    break;
                case 'ArrowRight':
                case 'd':
                case 'D':
                    changeDirection(1, 0);
                    break;
            }
        });

        // ç§»åŠ¨ç«¯æŒ‰é’®äº‹ä»¶ç›‘å¬
        document.getElementById('upBtn').addEventListener('click', () => changeDirection(0, -1));
        document.getElementById('downBtn').addEventListener('click', () => changeDirection(0, 1));
        document.getElementById('leftBtn').addEventListener('click', () => changeDirection(-1, 0));
        document.getElementById('rightBtn').addEventListener('click', () => changeDirection(1, 0));


        // åˆå§‹åŒ–æ¸¸æˆå’Œå¯åŠ¨å¾ªç¯
        document.addEventListener('DOMContentLoaded', () => {
            resetGame();
            requestAnimationFrame(gameLoop);
            
            // åˆå§‹æ˜¾ç¤ºå¼€å§‹ä¿¡æ¯
            gameMessage.classList.remove('hidden');
        });

    </script>
</body>
</html>